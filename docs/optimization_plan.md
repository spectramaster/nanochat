# NanoChat 高质量优化路线图

## 总体目标
- 构建模块化、结构化、逻辑严谨的代码架构，支持未来新增模型、训练策略与部署路径。
- 提升代码可读性、稳定性、可靠性，降低维护成本与功能扩展难度。
- 在保证性能的前提下完善工程质量体系，包括测试、监控与发布流程。

## 阶段划分概览
1. **基线评估与规划校准（第 0-1 周）**
2. **架构与模块化重构（第 2-5 周）**
3. **基础设施与工程质量提升（第 6-8 周）**
4. **稳定性、可靠性与运维体系完善（第 9-11 周）**
5. **持续优化与知识沉淀（第 12 周及之后）**

---

## 1. 基线评估与规划校准（第 0-1 周）✅
### 1.1 系统全景梳理
- **代码拓扑分析**：绘制核心模块依赖图（`nanochat/engine.py`, `execution.py`, `gpt.py`, `dataset.py`, `tokenizer.py`, `common.py` 等），识别循环依赖、跨层调用等问题。（已完成，详见 `docs/baseline_assessment.md`）
- **功能矩阵清单**：列举训练、推理、评测、UI 等功能与责任边界，确认当前存在的功能耦合点。（已完成，详见 `docs/baseline_assessment.md`）
- **配置现状调查**：审查 `configurator.py`, `common.py` 中的超参与环境配置处理方式。（已完成，详见 `docs/baseline_assessment.md`）

### 1.2 痛点诊断与优先级排序
- 收集团队反馈，统计 bug、运行异常、性能瓶颈、可维护性问题等。（已完成，详见 `docs/standards/pain_points_and_priorities.md`）
- 建立「影响度 × 解决成本」矩阵，确定短期与中长期重点。（已完成，详见 `docs/standards/pain_points_and_priorities.md`）

### 1.3 规划确认
- 明确架构原则（分层、依赖反转、单一责任等）。（已完成，详见 `docs/standards/architecture_principles.md`）
- 制定代码风格与规范文档（命名、注释、日志、异常处理等）。（已完成，详见 `docs/standards/architecture_principles.md`）
- 评审优化计划，明确资源投入与里程碑。（已完成，本路线图持续更新）

---

## 2. 架构与模块化重构（第 2-5 周）✅
### 2.1 目录与分层重构
- **划分核心层次**：
  - `core/`：模型结构、损失函数、优化器（已拆分 `gpt.py`, `loss_eval.py`, `adamw.py`）。
  - `data/`：数据加载、预处理、分词（已迁移 `dataset.py`, `dataloader.py`, `tokenizer.py`）。
  - `runtime/`：训练引擎、执行计划、调度（已归档 `engine.py`, `execution.py`, `muon.py`）。
  - `configs/`：默认配置、模板、实验配置（新增结构化配置加载器）。
  - `interfaces/`：UI、报告、可视化（已整合 `report.py`, `ui.html`, `logo.svg`）。
- 重构导入路径，建立统一入口（`nanochat/__init__.py` 暴露公共 API）。

### 2.2 模块职责划清
- 定义模块内公开接口与私有实现，采用依赖注入或工厂模式解耦组件（如优化器、调度器、模型）。（已完成，见新建 `nanochat/utils` 与 `nanochat/data` 接口）
- 将 `common.py` 中通用工具拆分至 `utils/`，按功能子模块组织（日志、文件 IO、并行工具等）。（已完成，并保留兼容层）

### 2.3 配置与参数管理
- 引入分层配置结构（默认值 → 环境覆盖 → 命令行/实验配置）。（已完成，参见 `nanochat/configs/loader.py`）
- 实现配置验证（pydantic/自定义 schema），为关键参数提供类型检查与默认值。（已完成，通过类型检查与 Key 校验保证安全）
- 增加配置快照与变更日志，支撑实验复现。（进行中，将在后续知识库中记录）
- 通过 `BaseTrainConfig` 数据类封装训练超参，统一脚本默认值与可追踪快照。（新增，支撑 Stage 3 配置治理）

### 2.4 接口与协议标准化
- 为训练循环、推理服务、评测流程定义统一协议（输入/输出结构、错误码）。（部分完成，已统一运行时 API 与数据加载协议）
- 为 UI、报告接口设计 REST/gRPC 或者 CLI 适配层，确保后端升级对前端影响最小。（进行中，后续会扩展）

---

## 3. 基础设施与工程质量提升（第 6-8 周）🔄
### 3.1 测试体系建设
- **单元测试**：覆盖核心模块（模型构建、数据预处理、配置解析、训练步骤）。（已补充配置加载器测试，并通过懒加载修复 `torch` 缺失导致的导入失败）
- **集成测试**：构建端到端样例管线（小模型+小数据集），验证训练、推理、评测完整闭环。（规划中）
- **回归测试**：引入基准指标库，确保优化后性能不回退。（规划中）
- 新增 `tests/test_dataset.py` 覆盖数据模块的可选依赖缺失场景，确保 `pyarrow` / `requests` 不存在时给出清晰错误并避免脚本崩溃。

### 3.2 静态分析与代码规范
- 集成 `ruff`、`mypy`/`pyright`、`pytest` 等工具，加入 CI。（已完成基础配置，待接入 CI）
- 定义 `pre-commit` 钩子统一代码风格（格式化、lint、type check）。（已新增 `.pre-commit-config.yaml`）
- 建立 PR 模板和代码评审清单，保障改动质量。（规划中）

### 3.3 文档与知识库
- 使用 `docs/` 目录存放架构说明、模块设计文档、API 说明与教程。（新增 `docs/README.md` 与中文手册，并更新路线图同步记录 Stage 3 进度）
- 建立变更日志与版本发布说明。（规划中）
- 对复杂模块提供时序图、状态图或流程图，提升理解成本。（规划中）

---

## 4. 稳定性、可靠性与运维体系完善（第 9-11 周）🔄
### 4.1 监控与日志
- 设计统一日志格式，区分不同层级（DEBUG/INFO/WARN/ERROR）。（已通过 `nanochat.utils.logging` 实现）
- 引入运行状态监控（训练进度、资源使用、异常捕获），支持远程追踪。（新增 `RuntimeMonitor`，可扩展接入外部系统）
- 在关键流程添加断言与健壮性校验（数据完整性、模型参数范围）。（进行中）

### 4.2 错误处理与容错
- 定义异常分类与处理策略，避免异常被静默吞掉。（新增 `nanochat.runtime.errors` 并在推理引擎中使用）
- 为训练与推理流程增加断点续训、任务重试机制。（规划中）
- 完善超时、资源不足时的降级策略与报警。（已在计算器工具链中抛出 `InferenceTimeout`）

### 4.3 发布与部署
- 设计 CI/CD 流水线：测试 → 构建 → 打包 → 发布。（规划中）
- 对推理/服务端部署加入蓝绿发布或灰度机制，降低发布风险。（规划中）
- 制定应急回滚与热补丁流程。（规划中）

---

## 5. 持续优化与知识沉淀（第 12 周及之后）
### 5.1 性能与成本优化
- 分析训练与推理性能指标，持续优化热点（算子融合、内存复用、分布式策略）。
- 建立成本监控机制，量化资源使用效率。

### 5.2 创新与功能扩展
- 在稳定架构上探索新模型结构、插件化模块（如多模态、对话管理策略）。
- 引入实验性功能的 Feature Flag 机制，隔离风险。

### 5.3 复盘与标准化
- 每个阶段结束进行复盘，沉淀最佳实践与踩坑记录。（新增 `docs/knowledge_base.md`）
- 将经验编写为团队内部标准，形成可继承的工程文化。（规划中）

---

## 里程碑与交付物清单
| 阶段 | 关键交付物 |
| --- | --- |
| 1 | 架构评估报告、痛点清单、优化原则与规范草案 |
| 2 | 新目录结构、模块化接口文档、配置管理系统 |
| 3 | 自动化测试体系、CI/CD 初版、开发文档与教程 |
| 4 | 监控与日志平台、稳定性提升报告、发布流程文档 |
| 5 | 性能优化报告、功能扩展 roadmap、团队知识库 |

---

## 成功衡量指标
- **可维护性**：代码审查平均耗时下降 ≥30%，模块耦合度指标降低。
- **可靠性**：关键流程失败率下降，回归测试覆盖率 ≥85%。
- **效率**：自动化流水线将手动操作减少 ≥50%，平均交付周期缩短。
- **可扩展性**：新增功能上线所需改动模块数减少，配置复用度提升。

该优化计划自基础梳理开始，逐步推进架构重构、工程体系建设与运维优化，确保每一步都为下一步奠定坚实基础，最终构建高质量、可持续演进的 NanoChat 项目。
